generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE: Users & Organizations
// ============================================

model User {
  id            String   @id // Clerk user ID (e.g., user_2abc123)
  email         String   @unique
  firstName     String?  @map("first_name")
  lastName      String?  @map("last_name")
  imageUrl      String?  @map("image_url")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  memberships Membership[]

  @@map("users")
}

model Organization {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  logo             String?
  plan             String   @default("starter")
  stripeCustomerId String?  @unique @map("stripe_customer_id")
  settings         Json     @default("{}")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Postiz Integration
  postizApiKey      String?   @map("postiz_api_key")
  postizOrgId       String?   @map("postiz_org_id")
  postizConnectedAt DateTime? @map("postiz_connected_at")

  memberships         Membership[]
  brands              Brand[]
  subscriptions       Subscription[]
  leads               Lead[]
  usage               Usage[]
  automations         Automation[]
  socialPostLogs      SocialPostLog[]
  autopilotSettings   AutopilotSettings?
  socialSuggestions   SocialSuggestion[]

  // Ads
  adAccounts          AdAccount[]
  adCampaigns         AdCampaign[]
  adRecommendations   AdRecommendation[]

  @@map("organizations")
}

model Membership {
  id             String   @id @default(cuid())
  userId         String   @map("user_id")
  organizationId String   @map("organization_id")
  role           String   @default("member") // owner, admin, member, viewer
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("memberships")
}

// ============================================
// BRANDS
// ============================================

model Brand {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  name           String
  slug           String
  logo           String?
  website        String?
  brandVoice     Json?    @map("brand_voice")
  brandColors    Json?    @map("brand_colors")
  targetAudience Json?    @map("target_audience")
  settings       Json     @default("{}")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  personas       Persona[]
  socialAccounts SocialAccount[]
  socialPosts    SocialPost[]
  voiceAgents    VoiceAgent[]
  phoneNumbers   PhoneNumber[]
  calls          Call[]
  leads          Lead[]

  @@unique([organizationId, slug])
  @@map("brands")
}

// ============================================
// PERSONAS (Unified Voice + Social)
// ============================================

model Persona {
  id                 String   @id @default(cuid())
  brandId            String   @map("brand_id")
  name               String
  role               String?
  avatar             String?
  personality        String?  @db.Text
  tone               String   @default("friendly")
  communicationStyle String?  @map("communication_style") @db.Text
  knowledgeAreas     Json?    @map("knowledge_areas")

  // Voice Channel Settings
  voiceEnabled  Boolean @default(true) @map("voice_enabled")
  voiceProvider String  @default("openai") @map("voice_provider")
  voiceId       String  @default("nova") @map("voice_id")
  voiceSettings Json    @default("{}") @map("voice_settings")

  // Social Channel Settings
  socialEnabled   Boolean @default(true) @map("social_enabled")
  writingStyle    String? @map("writing_style") @db.Text
  hashtagStrategy Json?   @map("hashtag_strategy")
  emojiUsage      String  @default("moderate") @map("emoji_usage")
  postTemplates   Json?   @map("post_templates")

  // Guardrails
  approvedTopics     Json? @map("approved_topics")
  forbiddenTopics    Json? @map("forbidden_topics")
  escalationTriggers Json? @map("escalation_triggers")

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  brand       Brand        @relation(fields: [brandId], references: [id], onDelete: Cascade)
  voiceAgents VoiceAgent[]
  socialPosts SocialPost[]

  @@map("personas")
}

// ============================================
// SOCIAL MEDIA
// ============================================

model SocialAccount {
  id           String    @id @default(cuid())
  brandId      String    @map("brand_id")
  platform     String
  platformId   String?   @map("platform_id")
  username     String?
  displayName  String?   @map("display_name")
  avatar       String?
  accessToken  String?   @map("access_token") @db.Text
  refreshToken String?   @map("refresh_token") @db.Text
  tokenExpires DateTime? @map("token_expires")
  settings     Json      @default("{}")
  isActive     Boolean   @default(true) @map("is_active")
  connectedAt  DateTime  @default(now()) @map("connected_at")

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([brandId, platform, platformId])
  @@map("social_accounts")
}

model SocialPost {
  id          String    @id @default(cuid())
  brandId     String    @map("brand_id")
  personaId   String?   @map("persona_id")
  content     String    @db.Text
  mediaUrls   Json      @default("[]") @map("media_urls")
  linkUrl     String?   @map("link_url")
  status      String    @default("draft")
  scheduledAt DateTime? @map("scheduled_at")
  publishedAt DateTime? @map("published_at")
  platforms   Json
  aiGenerated Boolean   @default(false) @map("ai_generated")
  prompt      String?   @db.Text
  metrics     Json      @default("{}")
  tags        Json      @default("[]")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  brand   Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  persona Persona? @relation(fields: [personaId], references: [id], onDelete: SetNull)

  @@map("social_posts")
}

// ============================================
// VOICE AI
// ============================================

model VoiceAgent {
  id              String   @id @default(cuid())
  brandId         String   @map("brand_id")
  personaId       String?  @map("persona_id")
  name            String
  description     String?  @db.Text
  systemPrompt    String?  @map("system_prompt") @db.Text
  greeting        String?  @db.Text
  fallbackMessage String?  @map("fallback_message") @db.Text
  llmProvider     String   @default("openai") @map("llm_provider")
  llmModel        String   @default("gpt-4-turbo") @map("llm_model")
  sttProvider     String   @default("deepgram") @map("stt_provider")
  ttsProvider     String   @default("openai") @map("tts_provider")
  voiceSettings   Json     @default("{}") @map("voice_settings")
  knowledgeBase   Json     @default("[]") @map("knowledge_base")
  isDeployed      Boolean  @default(false) @map("is_deployed")
  isActive        Boolean  @default(true) @map("is_active")
  transferNumber  String?  @map("transfer_number")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  brand        Brand         @relation(fields: [brandId], references: [id], onDelete: Cascade)
  persona      Persona?      @relation(fields: [personaId], references: [id], onDelete: SetNull)
  phoneNumbers PhoneNumber[]
  calls        Call[]

  @@map("voice_agents")
}

model PhoneNumber {
  id           String   @id @default(cuid())
  brandId      String?  @map("brand_id")
  agentId      String?  @map("agent_id")
  number       String   @unique
  provider     String
  providerId   String?  @map("provider_id")
  capabilities Json     @default("{\"voice\": true, \"sms\": false}")
  monthlyCost  Float    @default(0) @map("monthly_cost")
  isActive     Boolean  @default(true) @map("is_active")
  acquiredAt   DateTime @default(now()) @map("acquired_at")

  brand Brand?      @relation(fields: [brandId], references: [id], onDelete: SetNull)
  agent VoiceAgent? @relation(fields: [agentId], references: [id], onDelete: SetNull)
  calls Call[]

  @@map("phone_numbers")
}

model Call {
  id            String    @id @default(cuid())
  brandId       String?   @map("brand_id")
  agentId       String?   @map("agent_id")
  phoneNumberId String?   @map("phone_number_id")
  leadId        String?   @map("lead_id")
  direction     String
  fromNumber    String?   @map("from_number")
  toNumber      String?   @map("to_number")
  status        String    @default("initiated")
  outcome       String?
  startedAt     DateTime? @map("started_at")
  answeredAt    DateTime? @map("answered_at")
  endedAt       DateTime? @map("ended_at")
  duration      Int       @default(0)
  transcript    String?   @db.Text
  summary       String?   @db.Text
  sentiment     String?
  cost          Float     @default(0)
  recordingUrl  String?   @map("recording_url")
  roomId        String?   @map("room_id")
  metadata      Json      @default("{}")
  createdAt     DateTime  @default(now()) @map("created_at")

  brand       Brand?       @relation(fields: [brandId], references: [id], onDelete: SetNull)
  agent       VoiceAgent?  @relation(fields: [agentId], references: [id], onDelete: SetNull)
  phoneNumber PhoneNumber? @relation(fields: [phoneNumberId], references: [id], onDelete: SetNull)
  lead        Lead?        @relation(fields: [leadId], references: [id], onDelete: SetNull)

  @@map("calls")
}

// ============================================
// LEADS
// ============================================

model Lead {
  id             String    @id @default(cuid())
  organizationId String    @map("organization_id")
  brandId        String?   @map("brand_id")

  // Contact Info
  email          String?
  phone          String?
  firstName      String    @map("first_name")
  lastName       String?   @map("last_name")
  company        String?
  jobTitle       String?   @map("job_title")
  socialProfiles Json      @default("{}") @map("social_profiles")

  // Source
  source         String    @default("MANUAL")
  sourcePlatform String?   @map("source_platform")
  sourceDetails  String?   @map("source_details")
  utmParams      Json?     @map("utm_params")

  // Status & Value
  status         String    @default("NEW")
  score          Int       @default(0)
  estimatedValue Float?    @map("estimated_value")
  actualValue    Float?    @map("actual_value")
  currency       String    @default("USD")

  // Notes & Tags
  notes          String?   @db.Text
  tags           String[]  @default([])
  customFields   Json      @default("{}") @map("custom_fields")

  // Assignment
  assignedToId   String?   @map("assigned_to_id")

  // Timestamps
  firstTouchAt      DateTime? @map("first_touch_at")
  lastTouchAt       DateTime? @map("last_touch_at")
  lastContactedAt   DateTime? @map("last_contacted_at")
  convertedAt       DateTime? @map("converted_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  organization Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  brand        Brand?         @relation(fields: [brandId], references: [id], onDelete: SetNull)
  calls        Call[]
  activities   LeadActivity[]

  @@index([organizationId])
  @@index([status])
  @@index([source])
  @@index([createdAt])
  @@map("leads")
}

model LeadActivity {
  id            String   @id @default(cuid())
  leadId        String   @map("lead_id")

  type          String   // NOTE, EMAIL, CALL, MEETING, STATUS_CHANGE, TASK, SOCIAL_INTERACTION
  title         String
  description   String?  @db.Text
  metadata      Json     @default("{}")

  // Legacy fields for backward compatibility
  channel       String?
  referenceType String?  @map("reference_type")
  referenceId   String?  @map("reference_id")

  userId        String?  @map("user_id")
  createdAt     DateTime @default(now()) @map("created_at")

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([createdAt])
  @@map("lead_activities")
}

// ============================================
// BILLING
// ============================================

model Subscription {
  id                   String    @id @default(cuid())
  organizationId       String    @map("organization_id")
  stripeSubscriptionId String?   @unique @map("stripe_subscription_id")
  stripePriceId        String?   @map("stripe_price_id")
  plan                 String    @default("starter")
  status               String    @default("active")
  socialAccountsLimit  Int       @default(5) @map("social_accounts_limit")
  voiceMinutesLimit    Int       @default(250) @map("voice_minutes_limit")
  brandsLimit          Int       @default(1) @map("brands_limit")
  usersLimit           Int       @default(1) @map("users_limit")
  currentPeriodStart   DateTime? @map("current_period_start")
  currentPeriodEnd     DateTime? @map("current_period_end")
  trialEnd             DateTime? @map("trial_end")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model Usage {
  id              String   @id @default(cuid())
  organizationId  String   @map("organization_id")
  periodStart     DateTime @map("period_start")
  periodEnd       DateTime @map("period_end")
  postsCreated    Int      @default(0) @map("posts_created")
  aiImagesCreated Int      @default(0) @map("ai_images_created")
  voiceMinutes    Int      @default(0) @map("voice_minutes")
  aiTokensUsed    BigInt   @default(0) @map("ai_tokens_used")
  createdAt       DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, periodStart])
  @@map("usage")
}

// ============================================
// AUTOMATIONS
// ============================================

model Automation {
  id             String    @id @default(cuid())
  name           String
  description    String?   @db.Text

  // Trigger configuration
  trigger        String    // LEAD_CREATED, LEAD_STATUS_CHANGED, CALL_COMPLETED, CALL_FAILED, SOCIAL_ENGAGEMENT, SCHEDULE, MANUAL
  triggerConfig  Json?     @map("trigger_config")

  // Conditions (optional filters)
  conditions     Json?     // Array of conditions [{field, operator, value}]

  // Actions to execute
  actions        Json      // Array of actions [{type, config}]

  // Status
  isActive       Boolean   @default(true) @map("is_active")

  // Stats
  runCount       Int       @default(0) @map("run_count")
  lastRunAt      DateTime? @map("last_run_at")
  lastRunStatus  String?   @map("last_run_status") // SUCCESS, FAILED, SKIPPED

  // Relations
  organizationId String    @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  runs           AutomationRun[]

  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@index([organizationId])
  @@index([trigger])
  @@index([isActive])
  @@map("automations")
}

// Automation Run History
model AutomationRun {
  id             String    @id @default(cuid())

  status         String    // RUNNING, SUCCESS, FAILED, SKIPPED

  // Trigger data
  triggerData    Json?     @map("trigger_data")

  // Execution details
  actionsExecuted Json?    @map("actions_executed")
  error          String?   @db.Text

  // Timing
  startedAt      DateTime  @default(now()) @map("started_at")
  completedAt    DateTime? @map("completed_at")
  durationMs     Int?      @map("duration_ms")

  // Relations
  automationId   String    @map("automation_id")
  automation     Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([automationId])
  @@index([status])
  @@index([startedAt])
  @@map("automation_runs")
}

// ============================================
// SOCIAL POST LOGS (Track posts created via Epic AI)
// ============================================

model SocialPostLog {
  id              String   @id @default(cuid())

  // Content
  content         String   @db.Text
  mediaUrls       String[] @default([]) @map("media_urls")
  platforms       String[] @default([])

  // Postiz reference
  postizPostIds   String[] @default([]) @map("postiz_post_ids")

  // Scheduling
  status          String   @default("DRAFT") // DRAFT, SCHEDULED, POSTED, FAILED
  scheduledFor    DateTime? @map("scheduled_for")
  postedAt        DateTime? @map("posted_at")
  error           String?

  // AI Generation
  generatedBy     String   @default("MANUAL") @map("generated_by") // MANUAL, AI_LEAD, AI_CALL, AI_TREND
  sourceType      String?  @map("source_type")
  sourceId        String?  @map("source_id")
  aiPrompt        String?  @db.Text @map("ai_prompt")

  // Relations
  organizationId  String   @map("organization_id")
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([organizationId])
  @@index([status])
  @@map("social_post_logs")
}

// ============================================
// AUTOPILOT SETTINGS (Social AI automation)
// ============================================

model AutopilotSettings {
  id              String   @id @default(cuid())

  // Master toggle
  enabled                 Boolean  @default(false)

  // Triggers
  onLeadConverted         Boolean  @default(true) @map("on_lead_converted")
  onFiveStarCall          Boolean  @default(true) @map("on_five_star_call")
  onWeeklySchedule        Boolean  @default(false) @map("on_weekly_schedule")
  weeklyScheduleDay       Int?     @default(1) @map("weekly_schedule_day")  // 0=Sun, 1=Mon
  weeklyScheduleHour      Int?     @default(9) @map("weekly_schedule_hour") // Hour in UTC

  // Approval mode: REVIEW, AUTO_QUEUE, AUTO_POST
  approvalMode            String   @default("REVIEW") @map("approval_mode")

  // Default platforms (JSON array of integration IDs)
  defaultPlatforms        String[] @default([]) @map("default_platforms")

  // Posting limits
  maxPostsPerDay          Int      @default(3) @map("max_posts_per_day")
  minHoursBetween         Int      @default(4) @map("min_hours_between")

  // Brand voice
  defaultTone             String   @default("professional") @map("default_tone")
  includeEmojis           Boolean  @default(true) @map("include_emojis")
  includeHashtags         Boolean  @default(true) @map("include_hashtags")
  includeCTA              Boolean  @default(false) @map("include_cta")
  brandDescription        String?  @db.Text @map("brand_description")

  // Relations
  organizationId  String   @unique @map("organization_id")
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("autopilot_settings")
}

// ============================================
// SOCIAL SUGGESTIONS (AI-generated content ideas)
// ============================================

model SocialSuggestion {
  id              String   @id @default(cuid())

  // Content
  content         String   @db.Text
  imageUrl        String?  @map("image_url")

  // Source event: LEAD_CONVERTED, FIVE_STAR_CALL, WEEKLY_CONTENT, MANUAL
  triggerType     String   @map("trigger_type")
  triggerData     Json?    @map("trigger_data")

  // Suggested platforms (integration IDs)
  suggestedPlatforms String[] @default([]) @map("suggested_platforms")

  // Status: PENDING, APPROVED, POSTED, DISMISSED, FAILED, AUTO_POSTED
  status          String   @default("PENDING")

  // If posted
  postedAt        DateTime? @map("posted_at")
  postId          String?   @map("post_id") // Postiz post ID
  postPlatforms   String[]  @default([]) @map("post_platforms")

  // If dismissed
  dismissedAt     DateTime? @map("dismissed_at")
  dismissReason   String?   @map("dismiss_reason")

  // Relations
  organizationId  String   @map("organization_id")
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([organizationId, status])
  @@index([organizationId, createdAt])
  @@map("social_suggestions")
}

// ============================================
// ADS MODULE
// ============================================

model AdAccount {
  id        String   @id @default(cuid())
  orgId     String   @map("org_id")
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Platform
  platform  AdPlatform

  // Account info
  accountId     String?   @map("account_id")
  accountName   String    @map("account_name")

  // Credentials (encrypted in production)
  accessToken   String?   @map("access_token")
  refreshToken  String?   @map("refresh_token")
  tokenExpiry   DateTime? @map("token_expiry")

  // Status
  status    AdAccountStatus @default(PENDING)
  lastSync  DateTime?       @map("last_sync")
  syncError String?         @map("sync_error")

  // Campaigns
  campaigns AdCampaign[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([orgId, platform, accountId])
  @@index([orgId])
  @@map("ad_accounts")
}

enum AdPlatform {
  META
  GOOGLE
  LINKEDIN
  TIKTOK
  TWITTER
}

enum AdAccountStatus {
  PENDING
  CONNECTED
  DISCONNECTED
  ERROR
  MANUAL
}

model AdCampaign {
  id        String   @id @default(cuid())
  orgId     String   @map("org_id")
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Account reference
  adAccountId String?   @map("ad_account_id")
  adAccount   AdAccount? @relation(fields: [adAccountId], references: [id], onDelete: SetNull)

  // External reference
  externalId  String?   @map("external_id")

  // Campaign info
  name        String
  platform    AdPlatform
  objective   CampaignObjective @default(LEAD_GENERATION)
  status      CampaignStatus @default(DRAFT)

  // Budget
  dailyBudget   Decimal?  @db.Decimal(10, 2) @map("daily_budget")
  totalBudget   Decimal?  @db.Decimal(10, 2) @map("total_budget")
  currency      String    @default("USD")

  // Targeting (JSON)
  targeting     Json?

  // Schedule
  startDate     DateTime? @map("start_date")
  endDate       DateTime? @map("end_date")

  // Creative
  adCreatives   AdCreative[]

  // Performance (aggregated)
  metrics       AdCampaignMetrics?

  // Daily snapshots
  dailyMetrics  AdDailyMetrics[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([orgId])
  @@index([orgId, status])
  @@map("ad_campaigns")
}

enum CampaignObjective {
  AWARENESS
  TRAFFIC
  ENGAGEMENT
  LEAD_GENERATION
  CONVERSIONS
  SALES
}

enum CampaignStatus {
  DRAFT
  PENDING_REVIEW
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

model AdCreative {
  id         String   @id @default(cuid())
  campaignId String   @map("campaign_id")
  campaign   AdCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Creative type
  type      CreativeType @default(IMAGE)

  // Content
  headline       String
  primaryText    String    @map("primary_text")
  description    String?
  callToAction   String    @default("Learn More") @map("call_to_action")

  // Media
  imageUrl    String?   @map("image_url")
  videoUrl    String?   @map("video_url")

  // Destination
  destinationUrl String? @map("destination_url")

  // Status
  status    CreativeStatus @default(DRAFT)

  // Performance (per creative)
  impressions Int     @default(0)
  clicks      Int     @default(0)
  leads       Int     @default(0)
  spend       Decimal @default(0) @db.Decimal(10, 2)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([campaignId])
  @@map("ad_creatives")
}

enum CreativeType {
  IMAGE
  VIDEO
  CAROUSEL
  COLLECTION
}

enum CreativeStatus {
  DRAFT
  ACTIVE
  PAUSED
  REJECTED
}

model AdCampaignMetrics {
  id          String   @id @default(cuid())
  campaignId  String   @unique @map("campaign_id")
  campaign    AdCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Core metrics
  impressions   Int     @default(0)
  reach         Int     @default(0)
  clicks        Int     @default(0)
  leads         Int     @default(0)
  conversions   Int     @default(0)

  // Spend
  spend         Decimal @default(0) @db.Decimal(10, 2)

  // Calculated metrics
  ctr           Decimal? @db.Decimal(5, 4)
  cpc           Decimal? @db.Decimal(10, 2)
  cpl           Decimal? @db.Decimal(10, 2)
  cpa           Decimal? @db.Decimal(10, 2)

  // Last updated
  lastUpdated   DateTime @default(now()) @map("last_updated")

  @@map("ad_campaign_metrics")
}

model AdDailyMetrics {
  id          String   @id @default(cuid())
  campaignId  String   @map("campaign_id")
  campaign    AdCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Date
  date        DateTime @db.Date

  // Metrics
  impressions   Int     @default(0)
  clicks        Int     @default(0)
  leads         Int     @default(0)
  conversions   Int     @default(0)
  spend         Decimal @default(0) @db.Decimal(10, 2)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([campaignId, date])
  @@index([campaignId, date])
  @@map("ad_daily_metrics")
}

model AdRecommendation {
  id        String   @id @default(cuid())
  orgId     String   @map("org_id")
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Reference
  campaignId  String?  @map("campaign_id")
  creativeId  String?  @map("creative_id")

  // Recommendation
  type        RecommendationType
  title       String
  description String
  impact      RecommendationImpact @default(MEDIUM)

  // Action
  actionType  String?   @map("action_type")
  actionData  Json?     @map("action_data")

  // Status
  status      RecommendationStatus @default(PENDING)
  appliedAt   DateTime? @map("applied_at")
  dismissedAt DateTime? @map("dismissed_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([orgId, status])
  @@map("ad_recommendations")
}

enum RecommendationType {
  BUDGET_INCREASE
  BUDGET_DECREASE
  PAUSE_UNDERPERFORMING
  SCALE_WINNER
  NEW_CREATIVE
  AUDIENCE_EXPANSION
  SCHEDULE_OPTIMIZATION
}

enum RecommendationImpact {
  LOW
  MEDIUM
  HIGH
}

enum RecommendationStatus {
  PENDING
  APPLIED
  DISMISSED
  EXPIRED
}
