generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE: Users & Organizations
// ============================================

model User {
  id            String   @id // Clerk user ID (e.g., user_2abc123)
  email         String   @unique
  firstName     String?  @map("first_name")
  lastName      String?  @map("last_name")
  imageUrl      String?  @map("image_url")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  memberships Membership[]

  @@map("users")
}

model Organization {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  logo             String?
  plan             String   @default("starter")
  stripeCustomerId String?  @unique @map("stripe_customer_id")
  settings         Json     @default("{}")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  memberships   Membership[]
  brands        Brand[]
  subscriptions Subscription[]
  leads         Lead[]
  usage         Usage[]

  @@map("organizations")
}

model Membership {
  id             String   @id @default(cuid())
  userId         String   @map("user_id")
  organizationId String   @map("organization_id")
  role           String   @default("member") // owner, admin, member, viewer
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("memberships")
}

// ============================================
// BRANDS
// ============================================

model Brand {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  name           String
  slug           String
  logo           String?
  website        String?
  brandVoice     Json?    @map("brand_voice")
  brandColors    Json?    @map("brand_colors")
  targetAudience Json?    @map("target_audience")
  settings       Json     @default("{}")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  personas       Persona[]
  socialAccounts SocialAccount[]
  socialPosts    SocialPost[]
  voiceAgents    VoiceAgent[]
  phoneNumbers   PhoneNumber[]
  calls          Call[]
  leads          Lead[]

  @@unique([organizationId, slug])
  @@map("brands")
}

// ============================================
// PERSONAS (Unified Voice + Social)
// ============================================

model Persona {
  id                 String   @id @default(cuid())
  brandId            String   @map("brand_id")
  name               String
  role               String?
  avatar             String?
  personality        String?  @db.Text
  tone               String   @default("friendly")
  communicationStyle String?  @map("communication_style") @db.Text
  knowledgeAreas     Json?    @map("knowledge_areas")

  // Voice Channel Settings
  voiceEnabled  Boolean @default(true) @map("voice_enabled")
  voiceProvider String  @default("openai") @map("voice_provider")
  voiceId       String  @default("nova") @map("voice_id")
  voiceSettings Json    @default("{}") @map("voice_settings")

  // Social Channel Settings
  socialEnabled   Boolean @default(true) @map("social_enabled")
  writingStyle    String? @map("writing_style") @db.Text
  hashtagStrategy Json?   @map("hashtag_strategy")
  emojiUsage      String  @default("moderate") @map("emoji_usage")
  postTemplates   Json?   @map("post_templates")

  // Guardrails
  approvedTopics     Json? @map("approved_topics")
  forbiddenTopics    Json? @map("forbidden_topics")
  escalationTriggers Json? @map("escalation_triggers")

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  brand       Brand        @relation(fields: [brandId], references: [id], onDelete: Cascade)
  voiceAgents VoiceAgent[]
  socialPosts SocialPost[]

  @@map("personas")
}

// ============================================
// SOCIAL MEDIA
// ============================================

model SocialAccount {
  id           String    @id @default(cuid())
  brandId      String    @map("brand_id")
  platform     String
  platformId   String?   @map("platform_id")
  username     String?
  displayName  String?   @map("display_name")
  avatar       String?
  accessToken  String?   @map("access_token") @db.Text
  refreshToken String?   @map("refresh_token") @db.Text
  tokenExpires DateTime? @map("token_expires")
  settings     Json      @default("{}")
  isActive     Boolean   @default(true) @map("is_active")
  connectedAt  DateTime  @default(now()) @map("connected_at")

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([brandId, platform, platformId])
  @@map("social_accounts")
}

model SocialPost {
  id          String    @id @default(cuid())
  brandId     String    @map("brand_id")
  personaId   String?   @map("persona_id")
  content     String    @db.Text
  mediaUrls   Json      @default("[]") @map("media_urls")
  linkUrl     String?   @map("link_url")
  status      String    @default("draft")
  scheduledAt DateTime? @map("scheduled_at")
  publishedAt DateTime? @map("published_at")
  platforms   Json
  aiGenerated Boolean   @default(false) @map("ai_generated")
  prompt      String?   @db.Text
  metrics     Json      @default("{}")
  tags        Json      @default("[]")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  brand   Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  persona Persona? @relation(fields: [personaId], references: [id], onDelete: SetNull)

  @@map("social_posts")
}

// ============================================
// VOICE AI
// ============================================

model VoiceAgent {
  id              String   @id @default(cuid())
  brandId         String   @map("brand_id")
  personaId       String?  @map("persona_id")
  name            String
  description     String?  @db.Text
  systemPrompt    String?  @map("system_prompt") @db.Text
  greeting        String?  @db.Text
  fallbackMessage String?  @map("fallback_message") @db.Text
  llmProvider     String   @default("openai") @map("llm_provider")
  llmModel        String   @default("gpt-4-turbo") @map("llm_model")
  sttProvider     String   @default("deepgram") @map("stt_provider")
  ttsProvider     String   @default("openai") @map("tts_provider")
  voiceSettings   Json     @default("{}") @map("voice_settings")
  knowledgeBase   Json     @default("[]") @map("knowledge_base")
  isDeployed      Boolean  @default(false) @map("is_deployed")
  isActive        Boolean  @default(true) @map("is_active")
  transferNumber  String?  @map("transfer_number")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  brand        Brand         @relation(fields: [brandId], references: [id], onDelete: Cascade)
  persona      Persona?      @relation(fields: [personaId], references: [id], onDelete: SetNull)
  phoneNumbers PhoneNumber[]
  calls        Call[]

  @@map("voice_agents")
}

model PhoneNumber {
  id           String   @id @default(cuid())
  brandId      String?  @map("brand_id")
  agentId      String?  @map("agent_id")
  number       String   @unique
  provider     String
  providerId   String?  @map("provider_id")
  capabilities Json     @default("{\"voice\": true, \"sms\": false}")
  monthlyCost  Float    @default(0) @map("monthly_cost")
  isActive     Boolean  @default(true) @map("is_active")
  acquiredAt   DateTime @default(now()) @map("acquired_at")

  brand Brand?      @relation(fields: [brandId], references: [id], onDelete: SetNull)
  agent VoiceAgent? @relation(fields: [agentId], references: [id], onDelete: SetNull)
  calls Call[]

  @@map("phone_numbers")
}

model Call {
  id            String    @id @default(cuid())
  brandId       String?   @map("brand_id")
  agentId       String?   @map("agent_id")
  phoneNumberId String?   @map("phone_number_id")
  leadId        String?   @map("lead_id")
  direction     String
  fromNumber    String?   @map("from_number")
  toNumber      String?   @map("to_number")
  status        String    @default("initiated")
  outcome       String?
  startedAt     DateTime? @map("started_at")
  answeredAt    DateTime? @map("answered_at")
  endedAt       DateTime? @map("ended_at")
  duration      Int       @default(0)
  transcript    String?   @db.Text
  summary       String?   @db.Text
  sentiment     String?
  cost          Float     @default(0)
  recordingUrl  String?   @map("recording_url")
  roomId        String?   @map("room_id")
  metadata      Json      @default("{}")
  createdAt     DateTime  @default(now()) @map("created_at")

  brand       Brand?       @relation(fields: [brandId], references: [id], onDelete: SetNull)
  agent       VoiceAgent?  @relation(fields: [agentId], references: [id], onDelete: SetNull)
  phoneNumber PhoneNumber? @relation(fields: [phoneNumberId], references: [id], onDelete: SetNull)
  lead        Lead?        @relation(fields: [leadId], references: [id], onDelete: SetNull)

  @@map("calls")
}

// ============================================
// LEADS
// ============================================

model Lead {
  id             String    @id @default(cuid())
  organizationId String    @map("organization_id")
  brandId        String?   @map("brand_id")

  // Contact Info
  email          String?
  phone          String?
  firstName      String    @map("first_name")
  lastName       String?   @map("last_name")
  company        String?
  jobTitle       String?   @map("job_title")
  socialProfiles Json      @default("{}") @map("social_profiles")

  // Source
  source         String    @default("MANUAL")
  sourcePlatform String?   @map("source_platform")
  sourceDetails  String?   @map("source_details")
  utmParams      Json?     @map("utm_params")

  // Status & Value
  status         String    @default("NEW")
  score          Int       @default(0)
  estimatedValue Float?    @map("estimated_value")
  actualValue    Float?    @map("actual_value")
  currency       String    @default("USD")

  // Notes & Tags
  notes          String?   @db.Text
  tags           String[]  @default([])
  customFields   Json      @default("{}") @map("custom_fields")

  // Assignment
  assignedToId   String?   @map("assigned_to_id")

  // Timestamps
  firstTouchAt      DateTime? @map("first_touch_at")
  lastTouchAt       DateTime? @map("last_touch_at")
  lastContactedAt   DateTime? @map("last_contacted_at")
  convertedAt       DateTime? @map("converted_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  organization Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  brand        Brand?         @relation(fields: [brandId], references: [id], onDelete: SetNull)
  calls        Call[]
  activities   LeadActivity[]

  @@index([organizationId])
  @@index([status])
  @@index([source])
  @@index([createdAt])
  @@map("leads")
}

model LeadActivity {
  id            String   @id @default(cuid())
  leadId        String   @map("lead_id")

  type          String   // NOTE, EMAIL, CALL, MEETING, STATUS_CHANGE, TASK, SOCIAL_INTERACTION
  title         String
  description   String?  @db.Text
  metadata      Json     @default("{}")

  // Legacy fields for backward compatibility
  channel       String?
  referenceType String?  @map("reference_type")
  referenceId   String?  @map("reference_id")

  userId        String?  @map("user_id")
  createdAt     DateTime @default(now()) @map("created_at")

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([createdAt])
  @@map("lead_activities")
}

// ============================================
// BILLING
// ============================================

model Subscription {
  id                   String    @id @default(cuid())
  organizationId       String    @map("organization_id")
  stripeSubscriptionId String?   @unique @map("stripe_subscription_id")
  stripePriceId        String?   @map("stripe_price_id")
  plan                 String    @default("starter")
  status               String    @default("active")
  socialAccountsLimit  Int       @default(5) @map("social_accounts_limit")
  voiceMinutesLimit    Int       @default(250) @map("voice_minutes_limit")
  brandsLimit          Int       @default(1) @map("brands_limit")
  usersLimit           Int       @default(1) @map("users_limit")
  currentPeriodStart   DateTime? @map("current_period_start")
  currentPeriodEnd     DateTime? @map("current_period_end")
  trialEnd             DateTime? @map("trial_end")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model Usage {
  id              String   @id @default(cuid())
  organizationId  String   @map("organization_id")
  periodStart     DateTime @map("period_start")
  periodEnd       DateTime @map("period_end")
  postsCreated    Int      @default(0) @map("posts_created")
  aiImagesCreated Int      @default(0) @map("ai_images_created")
  voiceMinutes    Int      @default(0) @map("voice_minutes")
  aiTokensUsed    BigInt   @default(0) @map("ai_tokens_used")
  createdAt       DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, periodStart])
  @@map("usage")
}

// ============================================
// AUTOMATIONS
// ============================================

model Automation {
  id             String    @id @default(cuid())
  organizationId String    @map("organization_id")
  brandId        String?   @map("brand_id")
  name           String
  description    String?   @db.Text
  triggerType    String    @map("trigger_type")
  triggerConfig  Json      @map("trigger_config")
  actions        Json
  isActive       Boolean   @default(true) @map("is_active")
  timesTriggered Int       @default(0) @map("times_triggered")
  lastTriggered  DateTime? @map("last_triggered")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@map("automations")
}
